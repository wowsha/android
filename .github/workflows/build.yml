name: Build Android 6.0 x86_64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 720  # max 12 hours, Android builds can be very slow

    steps:
      - name: Setup 100GB tmpfs
        run: |
          sudo mount -t tmpfs -o size=100G tmpfs /tmp

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-8-jdk repo git-core gnupg flex bison gperf \
          build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \
          lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev ccache libgl1-mesa-dev

      - name: Initialize repo for Android 6.0.0_r1
        run: |
          cd /tmp
          repo init -u https://android.googlesource.com/platform/manifest -b android-6.0.0_r1

      - name: Sync repo
        run: |
          cd /tmp
          repo sync -c -j4 --no-clone-bundle --no-tags

      - name: Setup build environment
        run: |
          cd /tmp
          source build/envsetup.sh
          lunch aosp_x86_64-eng

      - name: Build Android
        run: |
          cd /tmp
          make -j$(nproc)

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-6.0.0-x86_64-build
          path: /tmp/out/target/product/generic_x86_64/*.iso
